<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Approval</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f4f4f9;
            color: #333;
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            position: fixed;
            height: 100%;
            transition: 0.3s;
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar h2, .sidebar span {
            display: block;
            transition: 0.3s;
        }
        .sidebar.collapsed h2, .sidebar.collapsed span {
            display: none;
        }
        .sidebar ul li {
            padding: 15px;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }
        .sidebar.collapsed ul li {
            justify-content: center;
        }
        .content {
            margin-left: 250px;
            padding: 20px;
            width: 100%;
            transition: 0.3s;
        }
        .content.expanded {
            margin-left: 60px;
        }
        .table-container {
            overflow-x: auto;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            .sidebar h2, .sidebar span {
                display: none;
            }
            .content {
                margin-left: 60px;
            }
        }

/* Batch Container */
.batch-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}


/* Responsive Design */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-250px); /* Hide sidebar on smaller screens */
    }
    .main-content {
        margin-left: 0; /* No margin for sidebar on smaller screens */
    }
    .sidebar.open {
        transform: translateX(0); /* Show sidebar when toggled */
    }
}
/* Batch Container */
.batch-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Batch Form */
#batchForm {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#batchForm label {
    font-weight: bold;
}

.batch-box {
    border: 1px solid #ccc;
    padding: 15px;
    background: #f9f9f9;
    text-align: center;
    border-radius: 8px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}
@media (max-width: 768px) {
    .batch-box {
        width: 100%; /* Make the batch box take up full width on smaller screens */
    }
}

.batch-box h3 {
    margin: 0;
    font-size: 1.2em;
}

/* Text */
.batch-container p,
.batch-box p {
    margin: 0;
}
#batchList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Adjust width as needed */
    gap: 15px; /* Space between batch boxes */
    padding: 10px;
}
.batch-box .fullscreen-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #4CAF50; /* Green */
    border: none;
    color: white;
    padding: 5px 10px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    border-radius: 5px;
    cursor: pointer;
}
.batch-box.fullscreen {
    position: fixed; /* Make the batch box fixed for fullscreen */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000; /* Ensure it's on top */
    background-color: white; /* Optional background color */
}
.batch-box.fullscreen .fullscreen-toggle {
    top: 10px;
    right: 10px;
}

.batch-box.fullscreen h3 {
    margin-top: 20px;
}

.batch-box.fullscreen p {
    margin-top: 10px;
}

#batchContainer button {
    background-color: #4CAF50; /* Green */
    border: none;
    color: white;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
}

/* Farmer Checkboxes Container */
#farmerCheckboxes {
    display: flex;
    flex-direction: column;
    gap: 5px;
    max-height: 200px; /* Set max height for scrolling */
    overflow-y: auto;  /* Enable vertical scrolling */
}

/* Farmer Checkboxes */
#farmerCheckboxes input[type="checkbox"] {
    margin-right: 5px;
}

/* ... your existing CSS ... */

.batch-button-container {
    display: inline-block; /* Make the container inline-block to control width */
    width: 200px; /* Set the desired width for the container */
    text-align: center; /* Center the button within the container */
}

@media (max-width: 768px) {
    .batch-button-container {
        width: 100%; /* Make the container take up full width on smaller screens */
    }
}

.modal-content {
  /* ... your existing styles ... */
  width: 50%;  margin: 0 auto; /* Center the modal horizontally */
  padding: 20px; /* Add some padding around the content */
}

.modal-content h2 {
  text-align: center; /* Center the modal title */
  margin-bottom: 20px; /* Add some spacing below the title */
}

#batchForm {
  display: flex;
  flex-direction: column;
  gap: 15px; /* Adjust spacing between form elements */
}

#batchForm label {
  font-weight: bold;
}

#batchForm input,
#batchForm select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#batchForm button {
  background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease; /* Add a hover effect */
}

#batchForm button:hover {
  background-color: #3e8e41; /* Darker green on hover */
}





</style>
<body>
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="LOGO1.png" alt="Logo" width="40">
            <span>ARMS</span>
        </div>
        <h2>Admin Dashboard</h2>
        <button id="toggleSidebar" class="btn btn-sm btn-light">â˜°</button>
        <ul>
            <li onclick="window.location.href='dashboard.html'">
                <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
            </li>
            <li onclick="window.location.href='admin.html'">
                <i class="fas fa-user-friends"></i> <span>Farmers</span>
            </li>
            <li onclick="window.location.href='add-distribution.html'">
                <i class="fas fa-clipboard-list"></i> <span>Distribution Records</span>
            </li>
            <li onclick="window.location.href='farmers-record.html'">
                <i class="fas fa-seedling"></i> <span>Farmers Activities</span>
            </li>
            <li onclick="window.location.href='manage_users.html'">
                <i class="fas fa-users-cog"></i> <span>User Management</span>
            </li>
            <li onclick="window.location.href='admin_password_management.html'">
                <i class="fas fa-key"></i> <span>Password Management</span>
            </li>
            <li onclick="window.location.href='logout.php'">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </li>
        </ul>
        
    </div>
    <div class="content" id="content">
        <div class="batch-container" id="batchContainer">
            <div class="batch-button-container"> 
                <button onclick="openBatchModal()">
                    <i class="fas fa-plus-circle"></i> Create Batch
                </button>
            </div>
            <div id="batchList"></div>
        </div>
    </div>
    <!-- Modal for Creating New Batch -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeBatchModal()">&times;</span>
            <h2>Create New Distribution Batch</h2>
            <form id="batchForm">
                <label for="batchName">Batch Name</label>
                <select id="batchName" name="batchName" required onchange="generateBatchNumber()">
                    <option value="" disabled selected>Select Batch Name</option>
                    <option value="Seeds">Seeds</option>
                    <option value="Fertilizer">Fertilizer</option>
                    <option value="Pesticide">Pesticide</option>
                    <option value="Herbicide">Herbicide</option>
                    <option value="Rodenticide">Rodenticide</option>
                </select>
                <label for="batchNumber">Batch Number</label>
                <input type="text" id="batchNumber" name="batchNumber" readonly required>
                <label for="totalQuantity">Total Quantity</label>
                <input type="number" id="totalQuantity" name="totalQuantity" min="1" required>
                <button type="submit" class="button">Create Batch</button>
            </form>
            <div id="batchContainer"></div>
        </div>
    </div>
       <!-- Modal for Adding Distribution Record -->
       <div id="distributionModal" class="modal">
            <div class="modal-dialog modal-fullscreen">  <!-- Add modal-fullscreen -->
                <div class="modal-content">
            <span class="modal-close" onclick="closeDistributionModal()">&times;</span>
            <h2>Add Distribution Record</h2>
            <input type="hidden" id="batchId" name="batchId">
            <form id="distributionForm">
                <input type="hidden" id="batchId" name="batchId">
                <label for="distributionBatchId">Batch ID</label>
                <select id="distributionBatchId"></select>
                <label for="distributedQuantity">Distributed Quantity</label>
                <input type="number" id="distributedQuantity" name="distributedQuantity" required>
                <label for="distributionDate">Date</label>
                <input type="date" id="distributionDate" name="distributionDate" required>
                <label for="barangaySelect">Select Barangay</label>
                <select id="barangaySelect" onchange="fetchFarmersByBarangay()">
                    <option value="" disabled selected>Select your Barangay</option>
                    <option value="Balacanas">Balacanas</option>
                    <option value="Dayawan">Dayawan</option>
                    <option value="Katipunan">Katipunan</option>
                    <option value="Kimaya">Kimaya</option>
                    <option value="Poblacion 1">Poblacion 1</option>
                    <option value="Poblacion 2">Poblacion 2</option>
                    <option value="Poblacion 3">Poblacion 3</option>
                    <option value="San Martin">San Martin</option>
                    <option value="Tambobong">Tambobong</option>
                    <option value="Imelda">Imelda</option>
                    <option value="Looc">Looc</option>
                </select>
                <div id="farmerSelectionContainer" style="display: none; margin-top: 20px;">
                    <label>Select Farmers from the chosen Barangay</label>
                    <div id="farmerCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    </div>
                </div>
                <button type="submit" class="button">Submit</button>
            </form>
        </div>
        <p id="responseMessage" style="display:none; margin-top:10px;"></p>

    </div>
    </div>

    <script>
        const toggleSidebar = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('content');

        toggleSidebar.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        });
    </script>
    <script>
// OPEN & CLOSE MODALS
function openBatchModal() {
    document.getElementById("batchModal").style.display = "block";
}

function closeBatchModal() {
    document.getElementById("batchModal").style.display = "none";
}

document.getElementById("batchForm").addEventListener("submit", function(event) {
    event.preventDefault();
    // Input validation
    const batchName = document.getElementById("batchName").value.trim();
    const batchNumber = document.getElementById("batchNumber").value.trim();
    const totalQuantity = document.getElementById("totalQuantity").value.trim();
    if (!batchName || !batchNumber || !totalQuantity || isNaN(totalQuantity) || totalQuantity <= 0) {
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Please fill out all fields correctly. Total Quantity must be greater than zero.'
        });
        return;
    }
    const formData = new FormData(this);
    fetch("create_batch.php", {
        method: "POST",
        body: formData,
    })
    .then((response) => {
        if(!response.ok){
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then((data) => {
        if (data.success) {
            addBatchBox(data.batchId, batchName, batchNumber, totalQuantity);
            closeBatchModal();
            loadBatches(); // Refresh the batch list after adding the new batch
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Batch created successfully!'
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: data.message || 'Failed to create batch.'
            });
        }
    })
    .catch((error) => {
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.message || 'An error occurred. Please try again.'
        });
        console.error("Error:", error);
    });
});

// Auto-generate Batch Number based on selected Batch Name
function generateBatchNumber() {
    const batchName = document.getElementById("batchName").value;

    if (!batchName) return;

    fetch(`fetch_latest_batch.php?batchName=${batchName}`)
        .then((response) => response.json())
        .then((data) => {
            const nextBatchNumber = data.latestBatch ? parseInt(data.latestBatch) + 1 : 1;
            document.getElementById("batchNumber").value = nextBatchNumber;
        })
        .catch((error) => {
            console.error("Error fetching batch number:", error);
            document.getElementById("batchNumber").value = "1"; // Default to 1 if error occurs
        });
}

function addBatchBox(batchId, batchName, batchNumber, totalQuantity) {
    const container = document.getElementById("batchList");

    const batchBox = document.createElement("div");
    batchBox.classList.add("batch-box");
    batchBox.dataset.batchId = batchId; // Store batchId in data attribute

    batchBox.innerHTML = `
        <h3>${batchName} - ${batchNumber}</h3>
        <p>Total Quantity: ${totalQuantity}</p>
        <button onclick="openDistributionModal(${batchId})">Add Distribution</button>
        <button class="fullscreen-toggle" onclick="toggleFullscreen(this)">Fullscreen</button>
    `;

    container.appendChild(batchBox);
}

function toggleFullscreen(button) {
    const batchBox = button.closest('.batch-box');
    batchBox.classList.toggle('fullscreen');
    const batchId = batchBox.dataset.batchId; // Get batchId from data attribute

    if (batchBox.classList.contains('fullscreen')) {
        fetch(`fetch_distributions.php?batchId=${batchId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear previous distributions
                    batchBox.querySelector('.distributions-list').innerHTML = '';

                    // Add distributions to the batch box
                    const distributionsList = batchBox.querySelector('.distributions-list');
                    data.distributions.forEach(distribution => {
                        const distributionItem = document.createElement('div');
                        distributionItem.classList.add('distribution-item');
                        distributionItem.innerHTML = `
                            <p>Distributed Quantity: ${distribution.distributedQuantity}</p>
                            <p>Date: ${distribution.distributionDate}</p>
                            <p>Barangay: ${distribution.barangay}</p>
                        `;
                        distributionsList.appendChild(distributionItem);
                    });
                } else {
                    displayError("Error fetching distributions: " + data.message);
                }
            })
            .catch(error => {
                displayError("Error fetching distributions: " + error.message);
            });
    } else {
        // Hide distributions or reset content
        batchBox.querySelector('.distributions-list').innerHTML = '';
    }
}



function loadBatches() {
    fetch('fetch_batches.php')
        .then(response => {
            if (!response.ok) throw new Error("HTTP Error " + response.status);
            return response.text(); // Read as text first
        })
        .then(text => {
            try {
                return JSON.parse(text); // Try parsing JSON
            } catch (error) {
                console.error("JSON Parse Error:", text); // Show error message
                throw new Error("Invalid JSON response");
            }
        })
        .then(data => {
            const batchContainer = document.getElementById('batchList');
            batchContainer.innerHTML = '';

            if (Array.isArray(data)) {
                data.forEach(batch => {
                    const batchDiv = document.createElement('div');
                    batchDiv.classList.add("batch-box");
                    batchDiv.innerHTML = `
                        <h3>${batch.batchName} - ${batch.batchNumber}</h3>
                        <p>Total Quantity: ${batch.totalQuantity}</p>
                        <button onclick="openDistributionModal(${batch.batchId})">Add Distribution</button>
                    `;
                    batchContainer.appendChild(batchDiv);
                });
            } else {
                batchContainer.innerHTML = `<p>Error: ${data.error || "Unexpected data format"}</p>`;
            }
        })
        .catch(error => console.error('Fetch Error:', error));
}


        // Ensure this runs when the page loads
        document.addEventListener('DOMContentLoaded', loadBatches);
        function openDistributionModal(batchId) {
    document.getElementById("distributionModal").style.display = "block";
    document.getElementById("batchId").value = batchId; // Set the batch ID
}

function closeDistributionModal() {
    document.getElementById("distributionModal").style.display = "none";
}

function openDistributionModal(batchId) {
    console.log("Opening modal with batchId:", batchId);

    const distributionBatchIdSelect = document.getElementById("distributionBatchId");
    distributionBatchIdSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';

    const batchIdInput = document.getElementById("batchId");
    if (batchIdInput) {
        batchIdInput.value = batchId;
    } else {
        console.error("Batch ID input field not found!");
    }

    fetch(`fetch_batch_details.php?batchId=${batchId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("API Response:", data);
            if (data.success && data.batch && data.batch.batchId && data.batch.batchNumber) {
                distributionBatchIdSelect.innerHTML = '';
                const option = document.createElement('option');
                option.value = data.batch.batchId;
                option.text = `${data.batch.batchId} - ${data.batch.batchNumber}`;
                distributionBatchIdSelect.appendChild(option); // Use appendChild
                // Consider using a modal library to show the modal instead of directly manipulating style.
                document.getElementById("distributionModal").style.display = "block";
            } else {
                displayError("Error fetching batch details: " + (data.message || "Invalid batch data received."));
            }
        })
        .catch(error => {
            displayError("Error fetching batch details: " + error.message);
        });
}


// Implement displayError function (example using alert for simplicity):
function displayError(message) {
    alert(message); // Replace with a more sophisticated error display in a production application.
}
 function fetchFarmersByBarangay() {
    const barangaySelect = document.getElementById('barangaySelect');
    const selectedBarangay = barangaySelect.value;
    const farmerCheckboxes = document.getElementById('farmerCheckboxes');
    
    farmerCheckboxes.innerHTML = ''; // Clear existing checkboxes

    if (!selectedBarangay) {
        document.getElementById('farmerSelectionContainer').style.display = 'none';
        return;
    }

    console.log("Fetching farmers for barangay:", selectedBarangay); // Debugging

    fetch(`fetch_farmers.php?barangay=${encodeURIComponent(selectedBarangay)}`)
    .then(response => response.text()) // Get raw text instead of JSON
    .then(text => {
        console.log("Raw Response:", text); // Check what's being returned
        try {
            const data = JSON.parse(text); // Now try parsing
            console.log("Parsed JSON:", data);
            
            if (data.success) {
                data.farmers.forEach(farmer => {
                    const farmerDiv = document.createElement("div");
                    farmerDiv.style.display = "flex";
                    farmerDiv.style.alignItems = "center";
                    farmerDiv.style.gap = "8px";
                    farmerDiv.style.padding = "5px";
                    farmerDiv.style.borderBottom = "1px solid #ddd";

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "farmers[]";
                    checkbox.value = farmer.rsbaNumber; // Store RSBA number instead of ID
                    checkbox.dataset.name = farmer.firstName + " " + farmer.lastName;


                    const label = document.createElement("label");
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(` ${farmer.firstName} ${farmer.lastName} (RSBA: ${farmer.rsbaNumber})`));
                    label.style.fontSize = "16px";
                    label.style.cursor = "pointer";

                    farmerDiv.appendChild(checkbox);
                    farmerDiv.appendChild(label);
                    farmerCheckboxes.appendChild(farmerDiv);
                });

                document.getElementById('farmerSelectionContainer').style.display = 'block';
            } else {
                displayError("No farmers found: " + data.message);
            }
        } catch (error) {
            displayError(`JSON Parsing Error: ${error.message}`);
        }
    })
    .catch(error => displayError("Error fetching farmers: " + error.message));
 }
 document.getElementById("distributionForm").addEventListener("submit", function (event) {
    event.preventDefault(); // Prevent default form submission

    // Collect selected farmer IDs from checkboxes
    let selectedFarmers = [];
    document.querySelectorAll('input[name="farmerIds[]"]:checked').forEach((checkbox) => {
        selectedFarmers.push(checkbox.value);
    });

    // Get other form values
    let batchId = document.getElementById("batchId").value;
    let distributionQuantity = document.getElementById("distributionQuantity").value;
    let distributionDate = document.getElementById("distributionDate").value;

    // Validate inputs
    if (selectedFarmers.length === 0) {
        alert("Please select at least one farmer.");
        return;
    }
    if (!distributionQuantity || distributionQuantity <= 0) {
        alert("Please enter a valid distribution quantity.");
        return;
    }

    // Prepare form data
    let formData = new FormData();
    formData.append("batchId", batchId);
    formData.append("distributionQuantity", distributionQuantity);
    formData.append("distributionDate", distributionDate);
    selectedFarmers.forEach((farmerId) => {
        formData.append("farmerIds[]", farmerId);
    });

    // Send AJAX request to PHP
    fetch("adddistribution.php", {
        method: "POST",
        body: formData,
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                alert("Distribution recorded successfully!");
                location.reload(); // Refresh the page after successful submission
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while processing the request.");
        });
});


// Function to get selected farmers
function getSelectedFarmers() {
    let selectedFarmers = [];
    document.querySelectorAll("input[name='farmerCheckbox']:checked").forEach((checkbox) => {
        selectedFarmers.push(checkbox.value);
    });
    return selectedFarmers;
}

</script>  
</body>
</html>

        

























        


 